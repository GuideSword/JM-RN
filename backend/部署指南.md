# 后端部署指南

## 快速开始

本指南涵盖从本地部署到公网部署的完整流程。

## 1. 服务器准备

### 1.1 安装依赖

```bash
sudo apt update
sudo apt install python3 python3-pip python3-venv python3-full nginx -y
```

### 1.2 上传代码

```bash
cd ~
# 方式1：使用git
git clone your-repo-url backend
# 方式2：使用scp上传
# scp -r backend/ root@your-server-ip:~/
cd backend
```

## 2. 创建虚拟环境

```bash
cd ~/backend

# 删除旧环境（如果有）
rm -rf venv

# 创建虚拟环境
python3 -m venv venv

# 验证创建成功
ls venv/bin/ | grep -E "python|pip"
```

## 3. 安装依赖

**重要：如果虚拟环境激活失败，使用完整路径**

```bash
# 方式A：激活虚拟环境（如果成功）
source venv/bin/activate
python3 -m pip install --upgrade pip
python3 -m pip install -r requirements.txt

# 方式B：使用完整路径（推荐，更可靠）
./venv/bin/python3 -m pip install --upgrade pip
./venv/bin/python3 -m pip install -r requirements.txt
```

## 4. 配置环境

### 4.1 创建目录

```bash
mkdir -p stock pdf
```

### 4.2 配置环境变量（可选）

创建 `.env` 文件：

```bash
nano .env
```

内容：

```env
API_HOST=0.0.0.0
API_PORT=8000
# 公网部署时，添加前端地址到CORS
CORS_ORIGINS=http://your-domain.com,https://your-domain.com,exp://localhost:8081
```

## 5. 测试运行

```bash
# 方式1：直接运行
./venv/bin/python3 -m app.main

# 方式2：使用uvicorn（推荐）
./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
```

验证：访问 `http://localhost:8000/health` 应返回 `{"status":"healthy"}`

## 6. 配置systemd服务（后台运行）

创建服务文件：

```bash
sudo nano /etc/systemd/system/jm-api.service
```

内容：

```ini
[Unit]
Description=JM Download API Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/backend
Environment="PATH=/root/backend/venv/bin"
EnvironmentFile=/root/backend/.env
ExecStart=/root/backend/venv/bin/python3 -m app.main
# 或使用uvicorn（推荐）
# ExecStart=/root/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable jm-api.service
sudo systemctl start jm-api.service
sudo systemctl status jm-api.service
```

查看日志：`sudo journalctl -u jm-api.service -f`

## 7. 公网部署配置

### 7.1 配置防火墙

```bash
# 方式A：直接使用8000端口
sudo ufw allow 8000/tcp

# 方式B：使用Nginx（推荐）
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

sudo ufw enable
```

**云服务器**：还需在控制台安全组中开放相应端口。

### 7.2 配置Nginx反向代理（推荐）

创建配置文件：

```bash
sudo nano /etc/nginx/sites-available/jm-api
```

内容：

```nginx
server {
    listen 80;
    server_name your-domain.com your-server-ip;

    client_max_body_size 500M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/jm-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 7.3 配置HTTPS（可选，推荐）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书（替换为你的域名）
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

### 7.4 配置前端应用

在移动应用的"设置"页面中：

- **使用IP**：`http://your-server-ip:8000`
- **使用域名**：`http://your-domain.com` 或 `https://your-domain.com`
- 点击"测试连接"验证

## 8. 常用命令

### 8.1 服务管理

```bash
# 启动/停止/重启
sudo systemctl start jm-api.service
sudo systemctl stop jm-api.service
sudo systemctl restart jm-api.service

# 查看状态
sudo systemctl status jm-api.service

# 查看日志
sudo journalctl -u jm-api.service -f
```

### 8.2 快速运行（不使用systemd）

```bash
cd ~/backend

# 直接运行
./venv/bin/python3 -m app.main

# 或使用uvicorn
./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 8.3 更新代码

```bash
cd ~/backend
git pull  # 或上传新代码
./venv/bin/python3 -m pip install -r requirements.txt
sudo systemctl restart jm-api.service
```

## 9. 常见问题

### Q1: externally-managed-environment 错误

**原因**：使用了系统Python而不是虚拟环境的Python

**解决**：使用完整路径
```bash
./venv/bin/python3 -m pip install -r requirements.txt
```

### Q2: 虚拟环境激活失败（which python3仍显示/usr/bin）

**解决**：不需要激活，直接使用完整路径
```bash
./venv/bin/python3 -m app.main
```

### Q3: ModuleNotFoundError: No module named 'fastapi'

**原因**：使用了系统Python而不是虚拟环境的Python

**解决**：使用完整路径运行
```bash
./venv/bin/python3 -m app.main
```

### Q4: 公网访问不到

1. 检查防火墙：`sudo ufw status`
2. 检查云服务器安全组规则
3. 检查后端是否监听 `0.0.0.0`（不是 `127.0.0.1`）
4. 检查Nginx配置：`sudo nginx -t`

### Q5: CORS错误

检查 `.env` 文件中的 `CORS_ORIGINS` 是否包含前端地址。

### Q6: 端口被占用

```bash
# 查看端口占用
sudo netstat -tulpn | grep 8000

# 或修改端口（修改.env文件中的API_PORT）
```

## 10. 部署架构对比

| 方案 | 地址 | 适用场景 |
|------|------|----------|
| 本地测试 | `http://localhost:8000` | 开发测试 |
| 局域网 | `http://192.168.x.x:8000` | 同一WiFi |
| 公网直连 | `http://your-server-ip:8000` | 简单部署 |
| 公网+Nginx | `http://your-domain.com` | 生产环境 |
| 公网+HTTPS | `https://your-domain.com` | 生产环境（推荐）|

## 11. 验证部署

```bash
# 本地测试
curl http://localhost:8000/health

# 公网测试
curl http://your-server-ip:8000/health
# 或
curl http://your-domain.com/health

# 应该返回：{"status":"healthy"}
```

访问API文档：`http://your-domain.com/docs`

---

**提示**：
- ✅ 支持局域网和公网部署
- ✅ 支持域名访问
- ✅ 支持HTTPS
- ✅ 建议使用Nginx反向代理
- ✅ 建议使用systemd后台运行
